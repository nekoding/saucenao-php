<?php

namespace Nekoding\Saucenao\Tests;

use Mockery;
use Mockery\Reflector;
use Nekoding\Saucenao\Saucenao;
use PHPUnit\Framework\TestCase;
use ReflectionClass;

class SaucenaoTest extends TestCase
{

    protected function setUp(): void
    {
        parent::setUp();
    }

    public function test_initialize_saucenao_package()
    {
        $saucenao = new Saucenao('dummy api key');
        $this->assertInstanceOf(Saucenao::class, $saucenao);

        $saucenaoSingleton = Saucenao::getOrCreateInstance('dummy api key');
        $this->assertInstanceOf(Saucenao::class, $saucenaoSingleton);

        $saucenaoSingleton2 = Saucenao::getOrCreateInstance('dummy api key1');
        $this->assertTrue($saucenaoSingleton === $saucenaoSingleton2);

        $this->assertFalse($saucenao === $saucenaoSingleton);
    }

    public function test_search_image_from_url()
    {
        $saucenao = Mockery::mock(Saucenao::class);

        $response = '{"header":{"user_id":"113258","account_type":"1","short_limit":"4","long_limit":"100","long_remaining":88,"short_remaining":3,"status":0,"results_requested":6,"index":{"0":{"status":0,"parent_id":0,"id":0,"results":6},"2":{"status":0,"parent_id":2,"id":2,"results":6},"5":{"status":0,"parent_id":5,"id":5,"results":6},"51":{"status":0,"parent_id":5,"id":51,"results":6},"52":{"status":0,"parent_id":5,"id":52,"results":6},"53":{"status":0,"parent_id":5,"id":53,"results":6},"6":{"status":0,"parent_id":6,"id":6,"results":6},"8":{"status":0,"parent_id":8,"id":8,"results":6},"9":{"status":0,"parent_id":9,"id":9,"results":12},"10":{"status":0,"parent_id":10,"id":10,"results":6},"11":{"status":0,"parent_id":11,"id":11,"results":6},"12":{"status":0,"parent_id":9,"id":12,"results":12},"16":{"status":0,"parent_id":16,"id":16,"results":6},"18":{"status":0,"parent_id":18,"id":18,"results":6},"19":{"status":0,"parent_id":19,"id":19,"results":6},"20":{"status":0,"parent_id":20,"id":20,"results":6},"21":{"status":0,"parent_id":21,"id":21,"results":6},"211":{"status":0,"parent_id":21,"id":211,"results":6},"22":{"status":0,"parent_id":22,"id":22,"results":6},"23":{"status":0,"parent_id":23,"id":23,"results":6},"24":{"status":0,"parent_id":24,"id":24,"results":6},"25":{"status":0,"parent_id":9,"id":25,"results":12},"26":{"status":0,"parent_id":9,"id":26,"results":12},"27":{"status":0,"parent_id":9,"id":27,"results":12},"28":{"status":0,"parent_id":9,"id":28,"results":12},"29":{"status":0,"parent_id":9,"id":29,"results":12},"30":{"status":0,"parent_id":9,"id":30,"results":12},"31":{"status":0,"parent_id":31,"id":31,"results":6},"32":{"status":0,"parent_id":32,"id":32,"results":6},"33":{"status":0,"parent_id":33,"id":33,"results":6},"34":{"status":0,"parent_id":34,"id":34,"results":6},"341":{"status":0,"parent_id":341,"id":341,"results":6},"35":{"status":0,"parent_id":35,"id":35,"results":6},"36":{"status":0,"parent_id":36,"id":36,"results":6},"37":{"status":0,"parent_id":37,"id":37,"results":6},"371":{"status":0,"parent_id":371,"id":371,"results":6},"38":{"status":0,"parent_id":38,"id":38,"results":6},"39":{"status":0,"parent_id":39,"id":39,"results":6},"40":{"status":0,"parent_id":40,"id":40,"results":6},"41":{"status":0,"parent_id":41,"id":41,"results":6},"42":{"status":0,"parent_id":42,"id":42,"results":6},"43":{"status":0,"parent_id":43,"id":43,"results":6},"44":{"status":0,"parent_id":44,"id":44,"results":6}},"search_depth":"128","minimum_similarity":35.53,"query_image_display":"\/userdata\/IoHsr3Ceb.jpg.png","query_image":"IoHsr3Ceb.jpg","results_returned":6},"results":[{"header":{"similarity":"95.45","thumbnail":"https:\/\/img1.saucenao.com\/res\/pixiv\/11064\/manga\/110646935_p165.jpg?auth=q46Mk_-Algc1IZgldJirgQ\u0026exp=1693940400","index_id":5,"index_name":"Index #5: Pixiv Images - 110646935_p165.jpg","dupes":0,"hidden":0},"data":{"ext_urls":["https:\/\/www.pixiv.net\/member_illust.php?mode=medium\u0026illust_id=110646935"],"title":"NARUTO LOG","pixiv_id":110646935,"member_name":"LO","member_id":97261054}},{"header":{"similarity":"95.43","thumbnail":"https:\/\/img3.saucenao.com\/booru\/b\/f\/bfe01e03741c12f006c7dece0eabe9ce_2.jpg?auth=bI0nZ5E3sO8pXsnFobwNYA\u0026exp=1693940400","index_id":9,"index_name":"Index #9: Danbooru - bfe01e03741c12f006c7dece0eabe9ce_0.jpg","dupes":1,"hidden":0},"data":{"ext_urls":["https:\/\/danbooru.donmai.us\/post\/show\/4748481","https:\/\/gelbooru.com\/index.php?page=post\u0026s=view\u0026id=6425188"],"danbooru_id":4748481,"gelbooru_id":6425188,"creator":"behindxa","material":"naruto (series), naruto shippuuden","characters":"uchiha itachi","source":"https:\/\/twitter.com\/behindxa\/status\/1342838675743277056"}},{"header":{"similarity":"34.53","thumbnail":"https:\/\/img1.saucenao.com\/res\/medibang\/1633\/16339753.jpg?auth=ou1o0UhQ9k9EfOyk_jFekA\u0026exp=1693940400","index_id":20,"index_name":"Index #20: MediBang - 16339753.jpg","dupes":0,"hidden":0},"data":{"ext_urls":["https:\/\/medibang.com\/picture\/g21910200659198040011293137"],"title":"happy hallowen","url":"https:\/\/medibang.com\/picture\/g21910200659198040011293137","member_name":"lovely drawings","member_id":11293137}},{"header":{"similarity":"34.26","thumbnail":"https:\/\/img1.saucenao.com\/res\/pixiv\/4905\/49051710_p0_master1200.jpg?auth=Ml7wEc0tgS3oZp4D8agIdw\u0026exp=1693940400","index_id":5,"index_name":"Index #5: Pixiv Images - 49051710_p0_master1200.jpg","dupes":0,"hidden":0},"data":{"ext_urls":["https:\/\/www.pixiv.net\/member_illust.php?mode=medium\u0026illust_id=49051710"],"title":"\u7504\u59ec","pixiv_id":49051710,"member_name":"0\u4e5f","member_id":10280467}},{"header":{"similarity":"34.26","thumbnail":"https:\/\/img1.saucenao.com\/res\/pixiv\/4905\/49051710_p0_master1200.jpg?auth=Ml7wEc0tgS3oZp4D8agIdw\u0026exp=1693940400","index_id":5,"index_name":"Index #5: Pixiv Images - 49051710_p0_master1200.jpg","dupes":0,"hidden":0},"data":{"ext_urls":["https:\/\/www.pixiv.net\/member_illust.php?mode=medium\u0026illust_id=49051710"],"title":"\u7504\u59ec","pixiv_id":49051710,"member_name":"0\u4e5f","member_id":10280467}},{"header":{"similarity":"34.03","thumbnail":"https:\/\/img3.saucenao.com\/dA2\/93204\/932045033.jpg?auth=fqHLHF2EJdEUPgPsrTmCmQ\u0026exp=1693940400","index_id":34,"index_name":"Index #34: deviantArt2 - 932045033.jpg","dupes":0,"hidden":0},"data":{"ext_urls":["https:\/\/deviantart.com\/view\/932045033"],"title":"Kiss the Doctor","da_id":"932045033","author_name":"GronHatchat","author_url":"https:\/\/www.deviantart.com\/gronhatchat"}}]}';
        $saucenao->shouldReceive('fromUrl')
            ->once()
            ->with('https://s1.zerochan.net/Uchiha.Itachi.600.3175530.jpg')
            ->andReturn(json_decode($response, true));

        $res = $saucenao->fromUrl("https://s1.zerochan.net/Uchiha.Itachi.600.3175530.jpg");

        $this->assertIsArray($res);
    }

    public function test_verify_response_methods()
    {
        $reflectionClass = new ReflectionClass(Saucenao::class);
        $reflectionMethod = $reflectionClass->getMethod('verifyResponse');
        $reflectionMethod->setAccessible(true);

        $response = '{"header":{"user_id":"113258","account_type":"1","short_limit":"4","long_limit":"100","long_remaining":88,"short_remaining":3,"status":0,"results_requested":6,"index":{"0":{"status":0,"parent_id":0,"id":0,"results":6},"2":{"status":0,"parent_id":2,"id":2,"results":6},"5":{"status":0,"parent_id":5,"id":5,"results":6},"51":{"status":0,"parent_id":5,"id":51,"results":6},"52":{"status":0,"parent_id":5,"id":52,"results":6},"53":{"status":0,"parent_id":5,"id":53,"results":6},"6":{"status":0,"parent_id":6,"id":6,"results":6},"8":{"status":0,"parent_id":8,"id":8,"results":6},"9":{"status":0,"parent_id":9,"id":9,"results":12},"10":{"status":0,"parent_id":10,"id":10,"results":6},"11":{"status":0,"parent_id":11,"id":11,"results":6},"12":{"status":0,"parent_id":9,"id":12,"results":12},"16":{"status":0,"parent_id":16,"id":16,"results":6},"18":{"status":0,"parent_id":18,"id":18,"results":6},"19":{"status":0,"parent_id":19,"id":19,"results":6},"20":{"status":0,"parent_id":20,"id":20,"results":6},"21":{"status":0,"parent_id":21,"id":21,"results":6},"211":{"status":0,"parent_id":21,"id":211,"results":6},"22":{"status":0,"parent_id":22,"id":22,"results":6},"23":{"status":0,"parent_id":23,"id":23,"results":6},"24":{"status":0,"parent_id":24,"id":24,"results":6},"25":{"status":0,"parent_id":9,"id":25,"results":12},"26":{"status":0,"parent_id":9,"id":26,"results":12},"27":{"status":0,"parent_id":9,"id":27,"results":12},"28":{"status":0,"parent_id":9,"id":28,"results":12},"29":{"status":0,"parent_id":9,"id":29,"results":12},"30":{"status":0,"parent_id":9,"id":30,"results":12},"31":{"status":0,"parent_id":31,"id":31,"results":6},"32":{"status":0,"parent_id":32,"id":32,"results":6},"33":{"status":0,"parent_id":33,"id":33,"results":6},"34":{"status":0,"parent_id":34,"id":34,"results":6},"341":{"status":0,"parent_id":341,"id":341,"results":6},"35":{"status":0,"parent_id":35,"id":35,"results":6},"36":{"status":0,"parent_id":36,"id":36,"results":6},"37":{"status":0,"parent_id":37,"id":37,"results":6},"371":{"status":0,"parent_id":371,"id":371,"results":6},"38":{"status":0,"parent_id":38,"id":38,"results":6},"39":{"status":0,"parent_id":39,"id":39,"results":6},"40":{"status":0,"parent_id":40,"id":40,"results":6},"41":{"status":0,"parent_id":41,"id":41,"results":6},"42":{"status":0,"parent_id":42,"id":42,"results":6},"43":{"status":0,"parent_id":43,"id":43,"results":6},"44":{"status":0,"parent_id":44,"id":44,"results":6}},"search_depth":"128","minimum_similarity":35.53,"query_image_display":"\/userdata\/IoHsr3Ceb.jpg.png","query_image":"IoHsr3Ceb.jpg","results_returned":6},"results":[{"header":{"similarity":"95.45","thumbnail":"https:\/\/img1.saucenao.com\/res\/pixiv\/11064\/manga\/110646935_p165.jpg?auth=q46Mk_-Algc1IZgldJirgQ\u0026exp=1693940400","index_id":5,"index_name":"Index #5: Pixiv Images - 110646935_p165.jpg","dupes":0,"hidden":0},"data":{"ext_urls":["https:\/\/www.pixiv.net\/member_illust.php?mode=medium\u0026illust_id=110646935"],"title":"NARUTO LOG","pixiv_id":110646935,"member_name":"LO","member_id":97261054}},{"header":{"similarity":"95.43","thumbnail":"https:\/\/img3.saucenao.com\/booru\/b\/f\/bfe01e03741c12f006c7dece0eabe9ce_2.jpg?auth=bI0nZ5E3sO8pXsnFobwNYA\u0026exp=1693940400","index_id":9,"index_name":"Index #9: Danbooru - bfe01e03741c12f006c7dece0eabe9ce_0.jpg","dupes":1,"hidden":0},"data":{"ext_urls":["https:\/\/danbooru.donmai.us\/post\/show\/4748481","https:\/\/gelbooru.com\/index.php?page=post\u0026s=view\u0026id=6425188"],"danbooru_id":4748481,"gelbooru_id":6425188,"creator":"behindxa","material":"naruto (series), naruto shippuuden","characters":"uchiha itachi","source":"https:\/\/twitter.com\/behindxa\/status\/1342838675743277056"}},{"header":{"similarity":"34.53","thumbnail":"https:\/\/img1.saucenao.com\/res\/medibang\/1633\/16339753.jpg?auth=ou1o0UhQ9k9EfOyk_jFekA\u0026exp=1693940400","index_id":20,"index_name":"Index #20: MediBang - 16339753.jpg","dupes":0,"hidden":0},"data":{"ext_urls":["https:\/\/medibang.com\/picture\/g21910200659198040011293137"],"title":"happy hallowen","url":"https:\/\/medibang.com\/picture\/g21910200659198040011293137","member_name":"lovely drawings","member_id":11293137}},{"header":{"similarity":"34.26","thumbnail":"https:\/\/img1.saucenao.com\/res\/pixiv\/4905\/49051710_p0_master1200.jpg?auth=Ml7wEc0tgS3oZp4D8agIdw\u0026exp=1693940400","index_id":5,"index_name":"Index #5: Pixiv Images - 49051710_p0_master1200.jpg","dupes":0,"hidden":0},"data":{"ext_urls":["https:\/\/www.pixiv.net\/member_illust.php?mode=medium\u0026illust_id=49051710"],"title":"\u7504\u59ec","pixiv_id":49051710,"member_name":"0\u4e5f","member_id":10280467}},{"header":{"similarity":"34.26","thumbnail":"https:\/\/img1.saucenao.com\/res\/pixiv\/4905\/49051710_p0_master1200.jpg?auth=Ml7wEc0tgS3oZp4D8agIdw\u0026exp=1693940400","index_id":5,"index_name":"Index #5: Pixiv Images - 49051710_p0_master1200.jpg","dupes":0,"hidden":0},"data":{"ext_urls":["https:\/\/www.pixiv.net\/member_illust.php?mode=medium\u0026illust_id=49051710"],"title":"\u7504\u59ec","pixiv_id":49051710,"member_name":"0\u4e5f","member_id":10280467}},{"header":{"similarity":"34.03","thumbnail":"https:\/\/img3.saucenao.com\/dA2\/93204\/932045033.jpg?auth=fqHLHF2EJdEUPgPsrTmCmQ\u0026exp=1693940400","index_id":34,"index_name":"Index #34: deviantArt2 - 932045033.jpg","dupes":0,"hidden":0},"data":{"ext_urls":["https:\/\/deviantart.com\/view\/932045033"],"title":"Kiss the Doctor","da_id":"932045033","author_name":"GronHatchat","author_url":"https:\/\/www.deviantart.com\/gronhatchat"}}]}';
        $result = $reflectionMethod->invoke(new Saucenao(''), $response);

        $this->assertIsArray($result);
    }
}
